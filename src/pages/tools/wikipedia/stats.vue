<script setup lang="ts">
import VChart from 'vue-echarts'

import type { EChartsCoreOption } from 'echarts/core'
import { use } from 'echarts/core'
import {
  LineChart,
} from 'echarts/charts'
import { SVGRenderer } from 'echarts/renderers'
import {
  DatasetComponent,
  GeoComponent,
  GridComponent,
  LegendComponent,
  TimelineComponent,
  TitleComponent,
  TooltipComponent,
  VisualMapComponent,

} from 'echarts/components'

// generate alpha-2 : name

use([
  SVGRenderer,
  LineChart,
  TitleComponent,
  TimelineComponent,
  GridComponent,
  DatasetComponent,
  TooltipComponent,
  LegendComponent,
  GeoComponent,
  VisualMapComponent,
])

const articleCounteDx = {
  x: [
    '2007.6.30',
    '2007.9.30',
    '2007.12.31',
    '2008.3.31',
    '2008.6.30',
    '2008.9.30',
    '2008.12.31',
    '2009.3.31',
    '2009.6.30',
    '2009.9.30',
    '2009.12.31',
    '2010.3.31',
    '2010.6.30',
    '2010.9.30',
    '2010.12.31',
    '2011.3.31',
    '2011.6.30',
    '2011.9.30',
    '2011.12.31',
    '2012.3.31',
    '2012.6.30',
    '2012.9.30',
    '2012.12.31',
    '2013.3.31',
    '2013.6.30',
    '2013.9.30',
    '2013.12.31',
    '2014.3.31',
    '2014.6.30',
    '2014.9.30',
    '2014.12.31',
    '2015.3.31',
    '2015.6.30',
    '2015.9.30',
    '2015.12.31',
    '2016.3.31',
    '2016.6.30',
    '2016.9.30',
    '2016.12.31',
    '2017.3.31',
    '2017.6.30',
    '2017.9.30',
    '2017.12.31',
    '2018.3.31',
    '2018.6.30',
    '2018.9.30',
    '2018.12.31',
    '2019.3.31',
    '2019.6.30',
    '2019.9.30',
    '2019.12.31',
    '2020.3.31',
    '2020.6.30',
    '2020.9.30',
    '2020.12.31',
    '2021.3.31',
  ],
  y: [
    158437.0,
    145020.0,
    136641.0,
    141524.0,
    130273.0,
    130920.0,
    113335.0,
    131166.0,
    112082.0,
    105890.0,
    99303.0,
    99184.0,
    91155.0,
    97660.0,
    93180.0,
    79966.0,
    77130.0,
    89290.0,
    79975.0,
    80677.0,
    93774.0,
    78741.0,
    76372.0,
    73069.0,
    76123.0,
    76755.0,
    78715.0,
    73956.0,
    75003.0,
    74462.0,
    76340.0,
    72441.0,
    73392.0,
    70193.0,
    70813.0,
    69840.0,
    68446.0,
    70205.0,
    70856.0,
    69387.0,
    62046.0,
    57689.0,
    64678.0,
    72244.0,
    65008.0,
    58057.0,
    59532.0,
    58427.0,
    57832.0,
    65149.0,
    53139.0,
    65905.0,
    69453.0,
    58358.0,
    62289.0,
    65560.0,
  ],
}
const categoryCountDx = {
  x: [
    '2006.3.1',
    '2006.4.1',
    '2006.5.1',
    '2006.6.1',
    '2006.7.1',
    '2006.8.1',
    '2006.9.1',
    '2006.10.1',
    '2006.11.1',
    '2006.12.1',
    '2007.1.1',
    '2007.2.1',
    '2007.3.1',
    '2007.4.1',
    '2007.5.1',
    '2007.6.1',
    '2007.7.1',
    '2007.8.1',
    '2007.9.1',
    '2007.10.1',
    '2007.11.1',
    '2007.12.1',
    '2008.1.1',
    '2008.2.1',
    '2008.3.1',
    '2008.4.1',
    '2008.5.1',
    '2008.6.1',
    '2008.7.1',
    '2008.8.1',
    '2008.9.1',
    '2008.10.1',
    '2008.11.1',
    '2008.12.1',
    '2009.1.1',
    '2009.2.1',
    '2009.3.1',
    '2009.4.1',
    '2009.5.1',
    '2009.6.1',
    '2009.7.1',
    '2009.8.1',
    '2009.9.1',
    '2009.10.1',
    '2009.11.1',
    '2009.12.1',
    '2010.1.1',
    '2010.2.1',
    '2010.3.1',
    '2010.4.1',
    '2010.5.1',
    '2010.6.1',
    '2010.7.1',
    '2010.8.1',
    '2010.9.1',
    '2010.10.1',
    '2010.11.1',
    '2010.12.1',
    '2011.1.1',
    '2011.2.1',
    '2011.3.1',
    '2011.4.1',
    '2011.5.1',
    '2011.6.1',
    '2011.7.1',
    '2011.8.1',
    '2011.9.1',
    '2011.10.1',
    '2011.11.1',
    '2011.12.1',
    '2012.1.1',
    '2012.2.1',
    '2012.3.1',
    '2012.4.1',
    '2012.5.1',
    '2012.6.1',
    '2012.7.1',
    '2012.8.1',
    '2012.9.1',
    '2012.10.1',
    '2012.11.1',
    '2012.12.1',
    '2013.1.1',
    '2013.2.1',
    '2013.3.1',
    '2013.4.1',
    '2013.5.1',
    '2013.6.1',
    '2013.7.1',
    '2013.8.1',
    '2013.9.1',
    '2013.10.1',
    '2013.11.1',
    '2013.12.1',
    '2014.1.1',
    '2014.2.1',
    '2014.3.1',
    '2014.4.1',
    '2014.5.1',
    '2014.6.1',
    '2014.7.1',
    '2014.8.1',
    '2014.9.1',
    '2014.10.1',
    '2014.11.1',
    '2014.12.1',
    '2015.1.1',
    '2015.2.1',
    '2015.3.1',
    '2015.4.1',
    '2015.5.1',
    '2015.6.1',
    '2015.7.1',
    '2015.8.1',
    '2015.9.1',
    '2015.10.1',
    '2015.11.1',
    '2015.12.1',
    '2016.1.1',
    '2016.2.1',
    '2016.3.1',
    '2016.4.1',
    '2016.5.1',
    '2016.6.1',
    '2016.7.1',
    '2016.8.1',
    '2016.9.1',
    '2016.10.1',
    '2016.11.1',
    '2016.12.1',
    '2017.1.1',
    '2017.2.1',
    '2017.3.1',
    '2017.4.1',
    '2017.5.1',
    '2017.6.1',
    '2017.7.1',
    '2017.8.1',
    '2017.9.1',
    '2017.10.1',
    '2017.11.1',
    '2017.12.1',
    '2018.1.1',
    '2018.2.1',
    '2018.3.1',
    '2018.4.1',
    '2018.5.1',
    '2018.6.1',
    '2018.7.1',
    '2018.8.1',
    '2018.9.1',
    '2018.10.1',
    '2018.11.1',
    '2018.12.1',
    '2019.1.1',
    '2019.2.1',
    '2019.3.1',
    '2019.4.1',
    '2019.5.1',
    '2019.6.1',
    '2019.7.1',
    '2019.8.1',
    '2019.9.1',
    '2019.10.1',
    '2019.11.1',
    '2019.12.1',
    '2020.1.1',
    '2020.2.1',
    '2020.3.1',
    '2020.4.1',
    '2020.5.1',
    '2020.6.1',
    '2020.7.1',
    '2020.8.1',
    '2020.9.1',
    '2020.10.1',
    '2020.11.1',
    '2020.12.1',
    '2021.1.1',
    '2021.2.1',
    '2021.3.1',
    '2021.4.1',
    '2021.5.1',
  ],
  y: [
    5422.0,
    6563.0,
    6985.0,
    8438.0,
    7539.0,
    7991.0,
    7161.0,
    7074.0,
    7946.0,
    9028.0,
    8896.0,
    8157.0,
    9342.0,
    10313.0,
    9587.0,
    9338.0,
    9882.0,
    9685.0,
    7313.0,
    8283.0,
    7186.0,
    8854.0,
    11688.0,
    9189.0,
    10524.0,
    10738.0,
    10442.0,
    12724.0,
    10559.0,
    11196.0,
    8917.0,
    8476.0,
    7441.0,
    6466.0,
    10145.0,
    8519.0,
    8920.0,
    9283.0,
    7201.0,
    7793.0,
    9601.0,
    9293.0,
    9400.0,
    10450.0,
    8934.0,
    8464.0,
    7757.0,
    9846.0,
    9122.0,
    8618.0,
    9281.0,
    8471.0,
    11056.0,
    11382.0,
    10653.0,
    10327.0,
    8747.0,
    12041.0,
    12355.0,
    10365.0,
    10226.0,
    10325.0,
    8990.0,
    12090.0,
    14862.0,
    14406.0,
    12644.0,
    11994.0,
    11086.0,
    10849.0,
    10307.0,
    8876.0,
    12310.0,
    9958.0,
    9407.0,
    11550.0,
    11007.0,
    10152.0,
    11230.0,
    15658.0,
    13216.0,
    12710.0,
    12410.0,
    12011.0,
    20869.0,
    15138.0,
    9015.0,
    11877.0,
    12123.0,
    11619.0,
    10458.0,
    10088.0,
    8718.0,
    8816.0,
    9125.0,
    7898.0,
    8295.0,
    8146.0,
    6905.0,
    8699.0,
    10609.0,
    9245.0,
    9367.0,
    10622.0,
    13610.0,
    11715.0,
    9782.0,
    10589.0,
    12710.0,
    11606.0,
    10907.0,
    16136.0,
    15397.0,
    15570.0,
    10273.0,
    10154.0,
    10198.0,
    11405.0,
    12188.0,
    12811.0,
    15649.0,
    16865.0,
    10872.0,
    11761.0,
    13040.0,
    16216.0,
    14349.0,
    14732.0,
    12434.0,
    17249.0,
    17029.0,
    25902.0,
    19048.0,
    13206.0,
    10499.0,
    11877.0,
    11422.0,
    11386.0,
    10081.0,
    9924.0,
    9387.0,
    12024.0,
    12572.0,
    9694.0,
    10985.0,
    9710.0,
    8927.0,
    9243.0,
    10196.0,
    8870.0,
    9185.0,
    9392.0,
    20153.0,
    10060.0,
    13920.0,
    9023.0,
    11366.0,
    10362.0,
    9244.0,
    6829.0,
    8648.0,
    7714.0,
    8444.0,
    10505.0,
    12216.0,
    13635.0,
    14260.0,
    10938.0,
    16450.0,
    11855.0,
    14531.0,
    12333.0,
    10804.0,
    27423.0,
    16604.0,
    10865.0,
    8905.0,
    9003.0,
    11307.0,
    8131.0,
    14570.0,
    11253.0,
    284.0,
  ],
}
const edgeCounteDx = {
  x: [
    '2007.6.30',
    '2007.9.30',
    '2007.12.31',
    '2008.3.31',
    '2008.6.30',
    '2008.9.30',
    '2008.12.31',
    '2009.3.31',
    '2009.6.30',
    '2009.9.30',
    '2009.12.31',
    '2010.3.31',
    '2010.6.30',
    '2010.9.30',
    '2010.12.31',
    '2011.3.31',
    '2011.6.30',
    '2011.9.30',
    '2011.12.31',
    '2012.3.31',
    '2012.6.30',
    '2012.9.30',
    '2012.12.31',
    '2013.3.31',
    '2013.6.30',
    '2013.9.30',
    '2013.12.31',
    '2014.3.31',
    '2014.6.30',
    '2014.9.30',
    '2014.12.31',
    '2015.3.31',
    '2015.6.30',
    '2015.9.30',
    '2015.12.31',
    '2016.3.31',
    '2016.6.30',
    '2016.9.30',
    '2016.12.31',
    '2017.3.31',
    '2017.6.30',
    '2017.9.30',
    '2017.12.31',
    '2018.3.31',
    '2018.6.30',
    '2018.9.30',
    '2018.12.31',
    '2019.3.31',
    '2019.6.30',
    '2019.9.30',
    '2019.12.31',
    '2020.3.31',
    '2020.6.30',
    '2020.9.30',
    '2020.12.31',
    '2021.3.31',
  ],
  y: [
    4161742.0,
    4352848.0,
    3798698.0,
    3828476.0,
    3346586.0,
    2422007.0,
    1564176.0,
    3133910.0,
    3008271.0,
    3019813.0,
    -199644.0,
    2953140.0,
    2927942.0,
    2671241.0,
    2624175.0,
    2743892.0,
    2583226.0,
    2491594.0,
    2400886.0,
    2424749.0,
    2593927.0,
    2372041.0,
    2423256.0,
    2487109.0,
    2461609.0,
    2353095.0,
    2378011.0,
    2516259.0,
    2291457.0,
    2339509.0,
    2388364.0,
    2540927.0,
    2425272.0,
    2577032.0,
    2385738.0,
    2494315.0,
    2381189.0,
    2395423.0,
    2431382.0,
    2512306.0,
    2367773.0,
    2405210.0,
    2373328.0,
    2521838.0,
    2375387.0,
    2324783.0,
    2262453.0,
    2410359.0,
    2381626.0,
    2433115.0,
    2389750.0,
    2359945.0,
    2857703.0,
    2737298.0,
    2580477.0,
    2878296.0,
  ],
}

const chartType = ref('article')
const chartTypeOption = ref([
  {
    value: 'article',
    label: '文章数',
    chartTitle: '维基百科季度文章变化量 (dx)',
  },
  {
    value: 'category',
    label: '分类数',
    chartTitle: '维基百科月度 Category 变化量 (dx)',
  },
  {
    value: 'links',
    label: '引用数',
    chartTitle: '维基百科季度引用变化量 (dx)',
  },
])

const guidNationText = computed(() => {
  if (chartType.value === 'article')
    return '维基百科季度文章变化量'

  else if (chartType.value === 'category')
    return '维基百科月度 Category 变化量'

  else if (chartType.value === 'links')
    return '维基百科季度引用变化量'
})

const chatData = computed(() => {
  let cache
  if (chartType.value === 'article')
    cache = articleCounteDx

  else if (chartType.value === 'category')
    cache = categoryCountDx

  else if (chartType.value === 'links')
    cache = edgeCounteDx
  cache = Object.assign({}, cache)
  cache.x = cache.x.map((item: any) => item.split('.').slice(0, -1).join('.'))
  return cache
})

const chartTitleMap = chartTypeOption.value.reduce((acc, item) => {
  // acc[item.value] = item
  acc.set(item.value, item.chartTitle)
  return acc
}, new Map<string, string>())

// provide(THEME_KEY, 'dark')
const option = ref<EChartsCoreOption>({
  title: {
    text: 'wikipeida 变化趋势',
    left: 'center',
  },
})
watchEffect(() => {
  option.value = {
    title: {
      text: chartTitleMap.get(chartType.value),
      left: 'center',
    },
    tooltip: {
      trigger: 'axis',
      position(pos: any, params: any, el: any, elRect: any, size: any) {
        const obj: any = { top: 30 }
        obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 130
        return obj
      },
      // extraCssText: 'width: 170px',
    },
    xAxis: {
      type: 'category',
      title: 'monthYear',
    },
    yAxis: {
      type: 'value',
      title: 'count',
    },
    legend: {
      orient: 'vertical',
      left: 'right',
      data: [[...chatData.value.x], [...chatData.value.y]],
    },
    dataset: {
      source: [[...chatData.value.x], [...chatData.value.y]],
    },
    series: [
      {
        datasetIndex: 0,
        type: 'line',
        name: '',
        seriesLayoutBy: 'row',
        encode: {
          x: 0,
          y: 1,
        },
      },

    ],
  }
})

// table
const tableColumns: any = ref([
  {
    title: '时间',
    key: 'datetime',
    width: 150,
  },
  {
    title: '数量',
    key: 'value',
  },
])

const tableData = ref([{ code: 'US', country: 'US', 2022: 100 }])
watchEffect(() => {
  tableData.value = []
  chatData.value.y.forEach((value, index) => {
    const dataRow: any = { value, datetime: chatData.value.x[index] }
    tableData.value.push(dataRow)
  })
})
</script>

<template>
  <n-grid cols="10" x-gap="12" item-responsive responsive="screen">
    <n-gi span="8 m:4 l:3">
      <div class="light-green" h-xs>
        {{ guidNationText }} <br>
      </div>

      <n-radio-group v-model:value="chartType" name="radiobuttongroup2" size="small">
        <n-radio-button
          v-for="item in chartTypeOption"
          :key="item.value"
          :value="item.value"
        >
          {{ item.label }}
        </n-radio-button>
      </n-radio-group>
    </n-gi>
    <n-gi span="8 m:6 l:7">
      <n-tabs justify-content="space-evenly" type="line">
        <n-tab-pane name="chap2" tab="趋势图">
          <div class="green">
            <VChart
              :option="option" autoresize h-xl
            />
          </div>
        </n-tab-pane>
        <n-tab-pane name="chap4" tab="数据表格">
          <n-data-table
            :columns="tableColumns"
            :data="tableData"
            :pagination="false"
            :bordered="true"
            :max-height="500"
            :scroll-x="3000"
            virtual-scroll
          />
        </n-tab-pane>
      </n-tabs>
    </n-gi>
    <n-gi span="8" />
  </n-grid>
</template>

<style scoped>
.light-green {
  display: flex;
  align-items: center;
  justify-content: center;
  /* height: 200px; */
  /* background-color: rgba(0, 128, 0, 0.12); */
}
.green {
  display: flex;
  align-items: center;
  justify-content: center;
  /* height: 200px; */
  /* background-color: rgba(0, 128, 0, 0.24); */
}
</style>
